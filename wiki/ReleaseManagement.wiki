#summary Release Management

<wiki:toc />

= Introduction =

Please keep in your mind the following release management rules:

  # Release early
  # Release often
  # Listen to your customer

Only released artifacts should be published (for future reference). This document shows how to manage release management with Maven and how to avoid tedious and error-prone manual tasks.

= Semantic Versioning =

Each release must be identified by unique version. It is important to keep versioning scheme consistent, e.g: `MAJOR.MINOR.FIX-QUALIFIER`, where:

  * `MAJOR` version must be incremented when any backwards incompatible changes are introduced.
  * `MINOR` version must be incremented if new, backwards compatible functionality is introduced.
  * `PATCH` version must be incremented if only backwards compatible bug fixes are introduced.
  * `QUALIFIER` part can be used to capture milestone builds.

For further details please refer to the [http://semver.org/ Semantic Versioning] article and [http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html#pom-reationships-sect-versions Project Versions] Maven Reference book chapter.

= SCM Layout = 

There are some standard, recommended ways to organize SCM (at least for SVN). For each project the following directories are created:

|| *Directory* || *Description* || *Tag/Branch Name* || *Application Version* ||
|| trunk || Main line of current development || N/A || MAJOR.MINOR-SNAPSHOT ||
|| branches || Bug fixing development || MAJOR.MINOR.x || MAJOR.MINOR.PATH-SNAPSHOT ||
|| tags || Markers for released revisions, *never changed when created* || MAJOR.MINOR or MAJOR.MINOR.PATCH || MAJOR.MINOR or MAJOR.MINOR.PATCH ||

= Release Management = 

This section documents Maven support for release management, aligned to the SCM layout and `MAJOR.MINOR.FIX` versioning scheme. If you want to know more about release management support in Maven, please refer to the great [http://www.sonatype.com/people/2011/01/using-the-maven-release-plugin-things-to-know/ article].  

== Minor Release ==

The most common scenario, when new minor release from trunk is released.

Pre-conditions:

  * Release is performed in the trunk directory.
  * Application version in trunk: `1.0-SNAPSHOT`.

Perform a minor release (accept all defaults during interactive Maven session):

{{{
mvn release:prepare release:perform -DperformRelease=true
}}}

Post-conditions:

  * Application version in trunk: `1.1-SNAPSHOT`.
  * New tag _application-name-1.0_.
  * Application version in tag _application-name-1.0_: `1.0`.
  * Released artifacts (with sources and javadoc) are published into the _enterprise repository_.
  * Latest released version is set to `1.0` in maven metadata (in the repository).
  * Project site is deployed.

== Major Release ==

The scenario when new major release from trunk is released.

Pre-conditions:

  * Release is performed in the trunk directory.
  * Application version in trunk: `1.1-SNAPSHOT`.

Perform a major release (accept all defaults during interactive Maven session):

{{{
mvn release:prepare release:perform -DperformRelease=true -DreleaseVersion=2.0
}}}

Post-conditions:

  * Application version in trunk: `2.1-SNAPSHOT`.
  * New tag _application-name-2.0_.
  * Application version in tag _application-name-2.0_: `2.0`.
  * Released artifacts (with sources and javadoc) are published into the repository.
  * Latest released version is set to `2.0` in maven metadata (in the repository).
  * Project site is deployed.

== Patch Release ==

The scenario when previously released version must be fixed. 

=== Step 1 ===

Pre-conditions:

  * Application version in tag _application-name-1.0_: `1.0`.

Create branch from from tag _application-name-1.0_ (accept all defaults during interactive Maven session):

{{{
mvn release:branch  -DbranchName=application-name-1.0.x -DreleaseVersion=1.0.1-SNAPSHOT \
  -DupdateBranchVersions=true -DupdateWorkingCopyVersions=false \
  -DsuppressCommitBeforeBranch=true -DremoteTagging=false
}}}

The command seems to be complex. And it is, due to the issue 10. By default `release:branch` goal commits intermediate results into the tag but once created tag must not be modified (even if you technically can).

Post-conditions:

  * Tag is unchanged.
  * New branch _application-name-1.0.x_ is created.
  * Application version in branch _application-name-1.0.x_: `1.0.1-SNAPSHOT`.

=== Step 2 ===

Pre-conditions:

  * Application version in branch _application-name-1.0.x_: `1.0.1-SNAPSHOT`.

Perform a patch release in branch directory _application-name-1.0.x_ (accept all defaults during interactive Maven session):

{{{
mvn release:prepare release:perform -DperformRelease=true \
  -DupdateReleaseInfo=false -Dgoals=deploy
}}}

Parameter `updateReleaseInfo` is set to false to avoid metadata modification in the repository by Maven Deploy Plugin. For "patch" releases we don't want to modify the latest release. E.g: if the latest release was 2.0 and the "patch" 1.0.1 is released, metadata in the repository should still define 2.0 as a latest release, not 1.0.1.

Parameter `goals` specifies that only artifact (with sources and javadoc) will be deployed into repository. Project site will not be changed (by default Maven Release Plugin calls `deploy site-deploy` goals).

Post-conditions:

  * Application version in branch _application-name-1.0.x_: `1.0.2-SNAPSHOT`.
  * New tag _application-name-1.0.1_.
  * Application version in tag _application-name-1.0.1_: `1.0.1`.
  * Released artifacts (with sources and javadoc) are published into the repository.
  * Latest released version is left unchanged in maven metadata (in the repository).
  * Project site is unchanged.

= Release Automation = 

Release management can be automated with continuous integration (CI) server. CI server can be used for build and release management as well. Advantages:

  * Minimal effort to perform a release (one button push).
  * Released version is built in the independent and controlled CI server environment, not on developer workstation.

== Bamboo Configuration ==

To configure release management in Bamboo server, set build plan strategy as manual build. Define the following Bamboo task goal:

{{{
mvn -B release:prepare release:perform -DperformRelease=true \
-Dusername=${bamboo.scm.username} -Dusername=${bamboo.scm.password}
}}}

_${bamboo.scm.username}_ and _${bamboo.scm.password}_ are build plan variables. You can specify the variables in the build plan configuration or as input values for parametrized manual build.

*Notice:* 

  SCM credentials (all variables in general) are shown in the Bamboo log (issue 11).